<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMMC v2.0 SAR Masterclass - Prof. Cyber</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-btn.active { color: #059669; border-bottom-color: #10b981; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Markdown Styles */
        .prose h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .prose h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; margin-top: 1rem; }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose strong { font-weight: 600; color: #0f172a; }
    </style>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0"
      }
    }
    </script>
</head>
<body class="bg-slate-50 text-slate-900 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-slate-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg class="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h1 class="text-xl font-bold leading-none">CMMC v2.0 Masterclass</h1>
                    <p class="text-xs text-slate-400 mt-1">Security Assessment Report (SAR) Module</p>
                </div>
            </div>
            <div class="hidden md:block text-sm text-slate-400 italic">
                Prof. Cyber's Interactive Study Guide
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200 shadow-sm sticky top-16 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-8 overflow-x-auto">
                <button onclick="app.switchTab('lecture')" id="tab-lecture" class="nav-btn active flex items-center gap-2 py-4 border-b-2 border-transparent whitespace-nowrap text-sm font-medium text-slate-500 hover:text-slate-700 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    Lecture Notes
                </button>
                <button onclick="app.switchTab('sar')" id="tab-sar" class="nav-btn flex items-center gap-2 py-4 border-b-2 border-transparent whitespace-nowrap text-sm font-medium text-slate-500 hover:text-slate-700 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    SAR Anatomy
                </button>
                <button onclick="app.switchTab('quiz')" id="tab-quiz" class="nav-btn flex items-center gap-2 py-4 border-b-2 border-transparent whitespace-nowrap text-sm font-medium text-slate-500 hover:text-slate-700 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    Knowledge Check
                </button>
                <button onclick="app.switchTab('tutor')" id="tab-tutor" class="nav-btn flex items-center gap-2 py-4 border-b-2 border-transparent whitespace-nowrap text-sm font-medium text-slate-500 hover:text-slate-700 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    Ask Professor
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <!-- TAB 1: LECTURE -->
        <div id="view-lecture" class="tab-content active space-y-8 max-w-4xl mx-auto">
            <div class="bg-white rounded-xl shadow-sm p-8 border border-slate-200">
                <h2 class="text-3xl font-bold text-slate-900 mb-6 border-b pb-4">
                    Module 1: Introduction to CMMC v2.0 & The SAR
                </h2>
                
                <div class="prose prose-slate max-w-none">
                    <h3 class="text-xl font-semibold text-emerald-700 mt-6">1.1 What is CMMC v2.0?</h3>
                    <p class="mt-2 leading-relaxed text-slate-600">
                        The <strong>Cybersecurity Maturity Model Certification (CMMC)</strong> is a Department of Defense (DoD) program designed to enforce the protection of sensitive unclassified information. Version 2.0 streamlines the original model into three levels:
                    </p>
                    <ul class="list-disc list-inside mt-4 space-y-2 text-slate-700 ml-4">
                        <li><strong>Level 1 (Foundational):</strong> 17 practices (Annual Self-Assessment).</li>
                        <li><strong>Level 2 (Advanced):</strong> 110 practices aligned with NIST SP 800-171 (Third-Party Assessment for critical national security information).</li>
                        <li><strong>Level 3 (Expert):</strong> 110+ practices based on NIST SP 800-172.</li>
                    </ul>

                    <h3 class="text-xl font-semibold text-emerald-700 mt-8">1.2 The Security Assessment Report (SAR)</h3>
                    <p class="mt-2 leading-relaxed text-slate-600">
                        The <strong>SAR</strong> is a critical artifact produced at the conclusion of a CMMC assessment. It details the <strong>results</strong> of the testing of controls defined in the System Security Plan (SSP).
                    </p>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-6 rounded-r">
                        <p class="font-medium text-blue-800">Professor's Note:</p>
                        <p class="text-blue-700 text-sm mt-1">
                            The SSP is your claim of compliance ("We do this"). The SAR is the verifier's grade ("They actually did this" or "They failed this").
                        </p>
                    </div>

                    <h3 class="text-xl font-semibold text-emerald-700 mt-8">1.3 Document Relationship</h3>
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="p-4 bg-slate-100 rounded-lg border border-slate-200">
                            <div class="font-bold text-slate-800">SSP</div>
                            <div class="text-xs text-slate-500 mt-1">System Security Plan</div>
                            <div class="text-sm mt-2 text-slate-600">Describes <em>how</em> security requirements are met.</div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-lg border border-emerald-200 relative">
                            <div class="absolute -left-3 top-1/2 -translate-y-1/2 hidden md:block text-slate-300">➜</div>
                            <div class="font-bold text-emerald-800">SAR</div>
                            <div class="text-xs text-emerald-600 mt-1">Security Assessment Report</div>
                            <div class="text-sm mt-2 text-slate-600">Documents the <em>findings</em> of the assessment.</div>
                            <div class="absolute -right-3 top-1/2 -translate-y-1/2 hidden md:block text-slate-300">➜</div>
                        </div>
                        <div class="p-4 bg-slate-100 rounded-lg border border-slate-200">
                            <div class="font-bold text-slate-800">POA&M</div>
                            <div class="text-xs text-slate-500 mt-1">Plan of Action & Milestones</div>
                            <div class="text-sm mt-2 text-slate-600">Plan to correct <em>deficiencies</em> found in SAR.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: DEEP DIVE -->
        <div id="view-sar" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-[calc(100vh-200px)] min-h-[600px]">
                <!-- Sidebar -->
                <div class="lg:col-span-1 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                    <div class="p-4 bg-slate-50 border-b border-slate-200">
                        <h3 class="font-bold text-slate-700">SAR Sections</h3>
                        <p class="text-xs text-slate-500">Click to explore each component</p>
                    </div>
                    <div class="flex-1 overflow-y-auto" id="sar-sidebar-list">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Details -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 p-8 flex flex-col">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-emerald-100 p-2 rounded-lg text-emerald-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <h2 id="sar-detail-title" class="text-2xl font-bold text-slate-800">Select a Section</h2>
                    </div>
                    <div class="prose prose-slate max-w-none flex-grow">
                        <p id="sar-detail-desc" class="text-lg text-slate-600 leading-relaxed mb-8">
                            Click on a section from the left menu to see its details and requirements.
                        </p>
                        <div id="sar-detail-critical" class="bg-slate-50 rounded-xl p-6 border border-slate-200 hidden">
                            <h4 class="font-semibold text-slate-900 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                Critical Elements to Review
                            </h4>
                            <ul id="sar-detail-list" class="space-y-3">
                                <!-- Injected via JS -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 3: QUIZ -->
        <div id="view-quiz" class="tab-content">
            <div class="max-w-3xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Knowledge Check</h2>
                    <span id="quiz-progress" class="text-sm font-medium text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                        Question 1
                    </span>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                    <div class="p-8">
                        <h3 id="quiz-question" class="text-xl font-medium text-slate-800 mb-6 leading-relaxed">
                            Loading...
                        </h3>

                        <div id="quiz-options" class="space-y-3">
                            <!-- Options Injected via JS -->
                        </div>

                        <div id="quiz-explanation" class="mt-8 p-6 rounded-lg hidden">
                            <h4 id="quiz-result-title" class="font-bold mb-2"></h4>
                            <p id="quiz-result-text"></p>
                            <div class="mt-6 flex justify-end">
                                <button id="btn-next-q" onclick="app.nextQuestion()" class="px-6 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-colors hidden">
                                    Next Question
                                </button>
                                <button id="btn-ai-q" onclick="app.generateAiQuestion()" class="hidden flex items-center gap-2 px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                    Generate AI Question
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: TUTOR -->
        <div id="view-tutor" class="tab-content">
            <div class="h-[600px] max-w-4xl mx-auto flex flex-col bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                <!-- Chat Header -->
                <div class="p-4 bg-slate-900 text-white flex items-center gap-3 shadow-sm">
                    <div class="p-2 bg-purple-500 rounded-full">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    </div>
                    <div>
                        <h3 class="font-bold">Professor Cyber</h3>
                        <div class="flex items-center gap-2 text-xs text-slate-300">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                            Online • Powered by Gemini 2.5
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center shrink-0">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        </div>
                        <div class="p-3 rounded-2xl text-sm leading-relaxed shadow-sm bg-white text-slate-800 border border-slate-200 rounded-tl-none">
                            Hello. I am Professor Cyber. I am here to help you master CMMC v2.0 and the Security Assessment Report. What is on your mind?
                        </div>
                    </div>
                </div>

                <!-- Input -->
                <div class="p-4 bg-white border-t border-slate-200">
                    <div class="flex items-end gap-2">
                        <textarea id="chat-input"
                            placeholder="Ask about findings, remediation, or evidence..."
                            class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none h-12 max-h-32"
                        ></textarea>
                        <button id="btn-send" onclick="app.sendMessage()" class="p-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-colors shadow-sm">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-8 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm">
            <p>&copy; 2025 CMMC Education Initiative. Built for educational purposes.</p>
        </div>
    </footer>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // --- STATE & DATA ---
        const SAR_DATA = [
            {
                id: 'exec-summary',
                title: '1. Executive Summary',
                description: 'Provides a high-level overview of the assessment engagement, the organization being assessed, and the final compliance determination.',
                criticalPoints: [
                    'Organization Name & CAGE Code',
                    'Assessment Scope (Facilities, Systems)',
                    'Date of Assessment',
                    'Overall Compliance Status (Met/Not Met)'
                ]
            },
            {
                id: 'methodology',
                title: '2. Assessment Methodology',
                description: 'Details the approach taken by the assessment team, including sampling rates and testing procedures. This proves the assessment was rigorous.',
                criticalPoints: [
                    'Sampling methodology used for assets',
                    'Tools used for scanning/testing',
                    'References to NIST SP 800-171A'
                ]
            },
            {
                id: 'findings',
                title: '3. Detailed Findings',
                description: 'The core of the document. Lists every practice assessed and the determination. This is the "graded exam" portion.',
                criticalPoints: [
                    'MET: Evidence supports implementation',
                    'NOT MET: Evidence is missing or insufficient',
                    'N/A: Practice does not apply (requires justification)'
                ]
            },
            {
                id: 'risks',
                title: '4. Risk Recommendation',
                description: 'Summary of risks posed by "NOT MET" practices. These feed directly into the POA&M.',
                criticalPoints: [
                    'Impact on CUI confidentiality',
                    'Recommendations for remediation',
                    'Basis for POA&M entry'
                ]
            }
        ];

        const QUIZ_DATA = [
            {
                text: "What is the primary purpose of the Security Assessment Report (SAR) in CMMC?",
                options: [
                    "To document the Plan of Action and Milestones (POA&M)",
                    "To serve as the 'System Security Plan' for the organization",
                    "To document the findings and risks identified during the assessment",
                    "To list all employees with access to CUI"
                ],
                correct: 2,
                explanation: "The SAR documents the findings (Met/Not Met) and risks. The SSP documents the implementation, and the POA&M documents the remediation plan."
            },
            {
                text: "True or False: A CMMC Level 2 assessment allows for an unlimited number of 'Not Met' practices.",
                options: ["True", "False"],
                correct: 1,
                explanation: "False. Failed critical practices prevent certification. Also, POA&M items are strictly time-bound."
            },
            {
                text: "Which document is the input that gets tested to create the SAR?",
                options: [
                    "NIST SP 800-53",
                    "System Security Plan (SSP)",
                    "The marketing brochures",
                    "Previous year tax returns"
                ],
                correct: 1,
                explanation: "The SSP describes the system boundaries and controls. The assessment tests the SSP to produce the SAR."
            }
        ];

        let currentQuizIndex = 0;
        let chatSession = null;
        const md = window.markdownit();

        // --- GEMINI SETUP ---
        const apiKey = process.env.API_KEY;
        const ai = new GoogleGenAI({ apiKey: apiKey });

        const SYSTEM_INSTRUCTION = `
        You are Professor Cyber, a distinguished and rigorous yet approachable Cybersecurity Professor.
        Your specialty is the Cybersecurity Maturity Model Certification (CMMC) v2.0 framework.
        You are currently teaching a master's level module on the Security Assessment Report (SAR).

        Your goals are:
        1. To explain complex CMMC concepts simply but accurately.
        2. To strictly adhere to CMMC v2.0 documentation standards.
        3. To help the student understand the relationship between the SAR, the System Security Plan (SSP), and the Plan of Action and Milestones (POA&M).
        4. If asked about specific controls, reference NIST SP 800-171.

        Tone: Academic, Encouraging, Authoritative.
        Format: Use Markdown for readability.

        If the user asks for a quiz question, generate a multiple-choice question about CMMC SAR.
        `;

        // --- APP FUNCTIONS ---
        window.app = {
            switchTab: (tabId) => {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
                
                document.getElementById(`view-${tabId}`).classList.add('active');
                document.getElementById(`tab-${tabId}`).classList.add('active');
            },

            // SAR Module Logic
            renderSarList: () => {
                const container = document.getElementById('sar-sidebar-list');
                container.innerHTML = SAR_DATA.map(section => `
                    <button onclick="app.viewSarSection('${section.id}')" 
                            class="w-full text-left p-4 border-b border-slate-100 hover:bg-slate-50 transition-colors flex items-center justify-between group"
                            id="btn-sar-${section.id}">
                        <span class="font-medium text-slate-600 group-hover:text-slate-900">${section.title}</span>
                        <svg class="w-4 h-4 text-slate-300 group-hover:text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                `).join('');
            },

            viewSarSection: (id) => {
                const section = SAR_DATA.find(s => s.id === id);
                if (!section) return;

                // Update Active State
                document.querySelectorAll('#sar-sidebar-list button').forEach(b => {
                    b.classList.remove('bg-emerald-50', 'border-l-4', 'border-l-emerald-500');
                    b.classList.add('border-l-4', 'border-l-transparent');
                });
                const btn = document.getElementById(`btn-sar-${id}`);
                if(btn) btn.classList.add('bg-emerald-50', 'border-l-emerald-500');

                // Render Content
                document.getElementById('sar-detail-title').innerText = section.title;
                document.getElementById('sar-detail-desc').innerText = section.description;
                document.getElementById('sar-detail-critical').classList.remove('hidden');
                document.getElementById('sar-detail-list').innerHTML = section.criticalPoints.map(p => `
                    <li class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-emerald-500 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-slate-700">${p}</span>
                    </li>
                `).join('');
            },

            // Quiz Logic
            renderQuiz: () => {
                if (currentQuizIndex >= QUIZ_DATA.length) {
                    // End of regular questions
                    document.getElementById('btn-next-q').classList.add('hidden');
                    document.getElementById('btn-ai-q').classList.remove('hidden');
                    return;
                }

                const q = QUIZ_DATA[currentQuizIndex];
                document.getElementById('quiz-progress').innerText = `Question ${currentQuizIndex + 1} of ${QUIZ_DATA.length}`;
                document.getElementById('quiz-question').innerText = q.text;
                
                document.getElementById('quiz-options').innerHTML = q.options.map((opt, idx) => `
                    <button onclick="app.checkAnswer(${idx})" class="w-full text-left p-4 rounded-lg border-2 border-slate-200 hover:border-blue-300 hover:bg-slate-50 transition-all quiz-opt-btn" data-idx="${idx}">
                        ${opt}
                    </button>
                `).join('');

                document.getElementById('quiz-explanation').classList.add('hidden');
                document.getElementById('btn-next-q').classList.add('hidden');
            },

            checkAnswer: (selectedIdx) => {
                const q = QUIZ_DATA[currentQuizIndex];
                const isCorrect = selectedIdx === q.correct;
                
                // Update UI
                document.querySelectorAll('.quiz-opt-btn').forEach(btn => {
                    btn.disabled = true;
                    const idx = parseInt(btn.dataset.idx);
                    if (idx === q.correct) {
                        btn.classList.add('border-emerald-500', 'bg-emerald-50');
                    } else if (idx === selectedIdx && !isCorrect) {
                        btn.classList.add('border-red-200', 'bg-red-50');
                    } else {
                        btn.classList.add('opacity-50');
                    }
                });

                const resultBox = document.getElementById('quiz-explanation');
                resultBox.classList.remove('hidden', 'bg-emerald-50', 'text-emerald-900', 'bg-amber-50', 'text-amber-900');
                resultBox.classList.add(isCorrect ? 'bg-emerald-50' : 'bg-amber-50');
                resultBox.classList.add(isCorrect ? 'text-emerald-900' : 'text-amber-900');

                document.getElementById('quiz-result-title').innerText = isCorrect ? 'Correct!' : 'Incorrect';
                document.getElementById('quiz-result-text').innerText = q.explanation;

                if (currentQuizIndex < QUIZ_DATA.length - 1) {
                     document.getElementById('btn-next-q').classList.remove('hidden');
                } else {
                     document.getElementById('btn-ai-q').classList.remove('hidden');
                }
            },

            nextQuestion: () => {
                currentQuizIndex++;
                app.renderQuiz();
            },

            generateAiQuestion: async () => {
                const btn = document.getElementById('btn-ai-q');
                btn.innerText = "Professor is thinking...";
                btn.disabled = true;

                try {
                    const session = await app.getChatSession();
                    const prompt = `Generate a single multiple choice quiz question about CMMC v2.0 Security Assessment Report (SAR). 
                    Format it strictly as JSON: 
                    {
                        "text": "question text",
                        "options": ["opt1", "opt2", "opt3", "opt4"],
                        "correct": 0,
                        "explanation": "reasoning"
                    }`;
                    
                    const result = await session.sendMessage({ message: prompt });
                    const text = result.text;
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    
                    if (jsonMatch) {
                        const newQ = JSON.parse(jsonMatch[0]);
                        QUIZ_DATA.push(newQ);
                        currentQuizIndex = QUIZ_DATA.length - 1;
                        app.renderQuiz();
                        // Reset button for next time
                        btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Generate AI Question`;
                        btn.disabled = false;
                        btn.classList.add('hidden'); // hide until answered
                    }
                } catch (e) {
                    console.error(e);
                    btn.innerText = "Error generating. Try again.";
                    btn.disabled = false;
                }
            },

            // Chat Logic
            getChatSession: async () => {
                if (!chatSession) {
                    chatSession = await ai.chats.create({
                        model: 'gemini-2.5-flash',
                        config: {
                            systemInstruction: SYSTEM_INSTRUCTION,
                            temperature: 0.7,
                        },
                    });
                }
                return chatSession;
            },

            sendMessage: async () => {
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if (!text) return;

                // Append User Message
                const history = document.getElementById('chat-history');
                history.innerHTML += `
                    <div class="flex gap-3 flex-row-reverse">
                        <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center shrink-0">
                            <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        </div>
                        <div class="p-3 rounded-2xl text-sm leading-relaxed shadow-sm bg-slate-800 text-white rounded-tr-none">
                            ${text}
                        </div>
                    </div>
                `;
                input.value = '';
                history.scrollTop = history.scrollHeight;

                // Add Loading State
                const loadingId = 'loading-' + Date.now();
                history.innerHTML += `
                    <div id="${loadingId}" class="flex gap-3">
                        <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center shrink-0">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        </div>
                        <div class="bg-white p-3 rounded-2xl rounded-tl-none border border-slate-200 shadow-sm">
                           <svg class="animate-spin h-5 w-5 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>
                `;
                history.scrollTop = history.scrollHeight;

                try {
                    const session = await app.getChatSession();
                    const result = await session.sendMessage({ message: text });
                    
                    // Remove Loading
                    document.getElementById(loadingId).remove();

                    // Append Bot Message
                    const htmlContent = md.render(result.text);
                    history.innerHTML += `
                        <div class="flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center shrink-0">
                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            </div>
                            <div class="p-3 rounded-2xl text-sm leading-relaxed shadow-sm bg-white text-slate-800 border border-slate-200 rounded-tl-none prose prose-sm max-w-none">
                                ${htmlContent}
                            </div>
                        </div>
                    `;
                    history.scrollTop = history.scrollHeight;

                } catch (e) {
                    console.error(e);
                    document.getElementById(loadingId).innerHTML = `<span class="text-red-500 text-sm">Error: ${e.message}</span>`;
                }
            }
        };

        // Initialize
        app.renderSarList();
        app.viewSarSection('exec-summary');
        app.renderQuiz();

        // Input Enter Key
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') app.sendMessage();
        });

    </script>
</body>
</html>
