<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMMC v2.0: Security Assessment Report (SAR) Study Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .nav-item.active {
            background-color: #1e40af;
            color: white;
        }

        /* Report Paper Styling */
        .paper-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1p, rgba(0, 0, 0, 0.06);
        }

        .sar-table th {
            background-color: #1e3a8a;
            color: white;
        }
        
        .sar-table tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .status-met { color: #166534; font-weight: bold; }
        .status-not-met { color: #991b1b; font-weight: bold; }
        .status-na { color: #525252; font-style: italic; }

        /* Tab Transitions */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bg-pattern {
            background-color: #1e3a8a;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%233b82f6' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* List Builder Styles */
        .asset-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        .asset-list li:last-child {
            border-bottom: none;
        }
        .asset-list .remove-btn {
            color: #991b1b;
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .asset-list li:hover .remove-btn {
            opacity: 1;
        }

        /* POA&M Table Styles */
        .poam-table {
            border-collapse: collapse;
        }
        .poam-table th, .poam-table td {
            padding: 8px;
            text-align: left;
            border: 1px solid #e5e7eb;
        }
        .poam-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        /* Assessor Team Table Styling */
        .team-table th {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            padding: 10px;
            font-weight: 600;
        }

        /* Print Styles for clean PDF export */
        @media print {
            body {
                background-color: white !important;
                margin: 0;
                padding: 0;
            }
            .header, .nav, .footer, .btn-print-area, .hidden-print {
                display: none !important;
            }
            .main-content, .print-area {
                width: 100% !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .tab-content {
                display: block !important;
                width: 100% !important;
                max-width: none !important;
                animation: none !important;
            }
            .report-page {
                padding: 1in; /* Standard page margin for print */
                page-break-after: always;
            }
            .sar-table {
                font-size: 8pt;
            }
            .sar-table th, .sar-table td {
                padding: 4px;
            }
            h2, h3, h4, h5 {
                page-break-after: avoid;
            }
            .poam-table {
                 page-break-before: auto;
            }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-pattern text-white shadow-lg z-10 header">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fa-solid fa-shield-halved text-2xl text-blue-300"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-wide">CMMC Academy</h1>
                    <p class="text-xs text-blue-200">Security Assessment Report (SAR)</p>
                </div>
            </div>
            <div class="hidden md:block text-sm opacity-80">
                Module: ASSESS-102
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden main-content">
        <!-- Sidebar Navigation -->
        <nav class="w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col overflow-y-auto hidden-print hidden md:flex nav">
            <div class="p-6">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-4">Course Material</h3>
                <ul class="space-y-2">
                    <li>
                        <button onclick="switchTab('overview')" id="btn-overview" class="nav-item active w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-blue-50 transition-colors">
                            <i class="fa-solid fa-book-open mr-2"></i> Overview: CMMC 2.0
                        </button>
                    </li>
                    <li>
                        <button onclick="switchTab('sar-deep-dive')" id="btn-sar-deep-dive" class="nav-item w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-blue-50 transition-colors">
                            <i class="fa-solid fa-microscope mr-2"></i> SAR Anatomy
                        </button>
                    </li>
                    <li>
                        <button onclick="switchTab('executive-summary')" id="btn-executive-summary" class="nav-item w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-blue-50 transition-colors">
                            <i class="fa-solid fa-file-signature mr-2"></i> Executive Summary
                        </button>
                    </li>
                    <li>
                        <button onclick="switchTab('methodology-scope')" id="btn-methodology-scope" class="nav-item w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-blue-50 transition-colors">
                            <i class="fa-solid fa-crosshairs mr-2"></i> Methodology & Scope
                        </button>
                    </li>
                    <li>
                        <button onclick="switchTab('team-credentials')" id="btn-team-credentials" class="nav-item w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-blue-50 transition-colors">
                            <i class="fa-solid fa-users-gear mr-2"></i> SAR Section 3: Team Credentials
                        </button>
                    </li>
                    <li>
                        <button onclick="switchTab('simulation')" id="btn-simulation" class="nav-item w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-blue-50 transition-colors">
                            <i class="fa-solid fa-laptop-code mr-2"></i> Lab: Write a SAR (4.0 Findings)
                        </button>
                    </li>
                    <li>
                        <button onclick="switchTab('risk-conclusion')" id="btn-risk-conclusion" class="nav-item w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-blue-50 transition-colors">
                            <i class="fa-solid fa-clipboard-check mr-2"></i> SAR Section 5: Conclusion
                        </button>
                    </li>
                    <li>
                        <button onclick="switchTab('final-report')" id="btn-final-report" class="nav-item w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-blue-50 transition-colors">
                            <i class="fa-solid fa-file-export mr-2"></i> SAR Section 6: Final Report
                        </button>
                    </li>
                </ul>
            </div>
            
            <div class="mt-auto p-6 border-t border-gray-100">
                <div class="bg-blue-50 rounded-lg p-4">
                    <h4 class="text-sm font-bold text-blue-800 mb-2">Key Definitions</h4>
                    <ul class="text-xs text-blue-700 space-y-1">
                        <li><strong>CUI:</strong> Controlled Unclassified Info</li>
                        <li><strong>FCI:</strong> Federal Contract Info</li>
                        <li><strong>Artifact:</strong> Tangible Proof (Evidentiary Matter)</li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Mobile Menu Button -->
        <div class="md:hidden absolute bottom-4 right-4 z-50">
            <button onclick="document.querySelector('nav').classList.toggle('hidden'); document.querySelector('nav').classList.toggle('absolute'); document.querySelector('nav').classList.toggle('z-40'); document.querySelector('nav').classList.toggle('h-full');" class="bg-blue-800 text-white p-4 rounded-full shadow-lg">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto p-6 md:p-12 relative">

            <!-- SECTION 1: OVERVIEW -->
            <div id="overview" class="tab-content active max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">CMMC 2.0: The Landscape</h2>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">SAR Context</h3>
                    <p class="text-gray-600 mb-4">
                        The <strong>Security Assessment Report (SAR)</strong> is the critical deliverable in the CMMC process, particularly for <strong>Level 2 Certification</strong>. It serves as the official record of the organization's cybersecurity maturity at a point in time, documenting how the security controls defined in the <strong>System Security Plan (SSP)</strong> were tested and what <strong>deficiencies</strong> were found.
                    </p>
                </div>

                <div class="bg-indigo-50 border-l-4 border-indigo-500 p-6 rounded-r-lg">
                    <h4 class="font-bold text-indigo-900 mb-2">The "Holy Trinity" of Documentation</h4>
                    <p class="text-sm text-indigo-800 mb-4">You cannot understand the SAR without understanding its siblings. In the DoD cybersecurity world, these three documents are inseparable:</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-white p-4 rounded shadow-sm">
                            <div class="font-bold text-gray-800">1. SSP</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide mb-2">System Security Plan</div>
                            <p class="text-xs text-gray-600">"Here is what we <strong>say</strong> we do to secure the system."</p>
                        </div>
                        <div class="bg-white p-4 rounded shadow-sm ring-2 ring-indigo-400">
                            <div class="font-bold text-gray-800">2. SAR</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide mb-2">Security Assessment Report</div>
                            <p class="text-xs text-gray-600">"Here is the <strong>proof</strong> of what is working and what failed."</p>
                        </div>
                        <div class="bg-white p-4 rounded shadow-sm">
                            <div class="font-bold text-gray-800">3. POA&M</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide mb-2">Plan of Action & Milestones</div>
                            <p class="text-xs text-gray-600">"Here is <strong>how</strong> we will fix what failed."</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 flex justify-end">
                    <button onclick="switchTab('sar-deep-dive')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-md">
                        Next: Analyze the SAR <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- SECTION 2: SAR DEEP DIVE -->
            <div id="sar-deep-dive" class="tab-content max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Anatomy of a SAR</h2>
                
                <p class="text-gray-600 mb-6">
                    The <strong>Security Assessment Report (SAR)</strong> is not just a checklist. It is a formal deliverable used by Authorizing Officials (or certifying bodies) to determine risk. For <strong>CMMC Level 2</strong>, the SAR is typically generated by the <strong>C3PAO (Certified Third-Party Assessment Organization)</strong> after they audit your environment against <strong>NIST 800-171</strong>.
                </p>

                <!-- Interactive SAR Explainer -->
                <div class="bg-white rounded-xl shadow paper-shadow overflow-hidden mb-8 border border-gray-200">
                    <div class="bg-gray-50 border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700">Standard SAR Structure</h3>
                        <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded">Based on NIST 800-171A</span>
                    </div>
                    <div class="p-0">
                        <div class="flex flex-col md:flex-row">
                            <!-- Index -->
                            <div class="w-full md:w-1/3 bg-gray-50 p-4 border-r border-gray-200 space-y-2">
                                <button onclick="showSarPart('executive')" class="w-full text-left p-2 rounded hover:bg-blue-100 text-sm font-medium text-gray-700 transition focus:bg-blue-100 focus:text-blue-800 active-sar-part">1. Executive Summary</button>
                                <button onclick="showSarPart('methodology')" class="w-full text-left p-2 rounded hover:bg-blue-100 text-sm font-medium text-gray-700 transition focus:bg-blue-100 focus:text-blue-800">2. Methodology & Scope</button>
                                <button onclick="showSarPart('team')" class="w-full text-left p-2 rounded hover:bg-blue-100 text-sm font-medium text-gray-700 transition focus:bg-blue-100 focus:text-blue-800">3. Assessment Team</button>
                                <button onclick="showSarPart('findings')" class="w-full text-left p-2 rounded hover:bg-blue-100 text-sm font-medium text-gray-700 transition focus:bg-blue-100 focus:text-blue-800">4. Detailed Findings (The Core)</button>
                                <button onclick="showSarPart('risk')" class="w-full text-left p-2 rounded hover:bg-blue-100 text-sm font-medium text-gray-700 transition focus:bg-blue-100 focus:text-blue-800">5. Risk Recommendation</button>
                            </div>
                            
                            <!-- Content Display -->
                            <div class="w-full md:w-2/3 p-6 min-h-[300px]">
                                <div id="sar-part-executive" class="sar-detail-view">
                                    <h4 class="text-lg font-bold text-blue-900 mb-2">1. Executive Summary</h4>
                                    <p class="text-sm text-gray-600 mb-4">This is for the C-Suite and the Authorizing Official. It contains no technical jargon.</p>
                                    <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
                                        <li><strong>Assessment Dates:</strong> When the audit occurred.</li>
                                        <li><strong>Participants:</strong> Who was interviewed (C3PAO Assessor, OSC Security Officer).</li>
                                        <li><strong>High-Level Result:</strong> Did the organization Pass, Fail, or receive a Conditional Pass?</li>
                                        <li><strong>Aggregated Risk:</strong> "The assessment identified 4 controls as Not Met, presenting a Moderate risk to CUI."</li>
                                    </ul>
                                </div>

                                <div id="sar-part-methodology" class="sar-detail-view hidden">
                                    <h4 class="text-lg font-bold text-blue-900 mb-2">2. Methodology & Scope</h4>
                                    <p class="text-sm text-gray-600 mb-4">Defines the "Battlefield". If it wasn't in scope, it wasn't tested.</p>
                                    <div class="bg-yellow-50 p-3 rounded border-l-4 border-yellow-400 text-xs text-yellow-800">
                                        <strong>Critical Concept: Scoping</strong><br>
                                        This section lists the specific "Assessment Boundary". It details any "Deviations" (e.g., if a specific server was offline and not tested) and the testing methods used (Interview, Examine, Test).
                                    </div>
                                </div>
                                
                                <div id="sar-part-team" class="sar-detail-view hidden">
                                    <h4 class="text-lg font-bold text-blue-900 mb-2">3. Assessment Team Credentials</h4>
                                    <p class="text-sm text-gray-600 mb-4">Mandatory section detailing the <strong>C3PAO</strong> and the credentials of the assessors, ensuring they are qualified to conduct the CMMC assessment.</p>
                                    <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
                                        <li><strong>C3PAO Name/ID:</strong> The authorized organization performing the audit.</li>
                                        <li><strong>Lead Assessor (CCA):</strong> Certified CMMC Assessor.</li>
                                        <li><strong>Quality Control Lead:</strong> Ensures assessment integrity.</li>
                                        <li><strong>Experience:</strong> Relevant experience for each member (e.g., "5 years GRC").</li>
                                    </ul>
                                </div>

                                <div id="sar-part-findings" class="sar-detail-view hidden">
                                    <h4 class="text-lg font-bold text-blue-900 mb-2">4. Detailed Findings</h4>
                                    <p class="text-sm text-gray-600 mb-4">The meat of the document. Every <strong>NIST 800-171</strong> control gets a row.</p>
                                    <table class="w-full text-xs border-collapse border border-gray-300">
                                        <thead>
                                            <tr class="bg-gray-100">
                                                <th class="border p-1">Control</th>
                                                <th class="border p-1">Status</th>
                                                <th class="border p-1">Observation</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="border p-1">AC.3.1.1</td>
                                                <td class="border p-1 text-green-700 font-bold">MET</td>
                                                <td class="border p-1">Observed AD settings enforcing access control.</td>
                                            </tr>
                                            <tr>
                                                <td class="border p-1">AT.3.2.1</td>
                                                <td class="border p-1 text-red-700 font-bold">NOT MET</td>
                                                <td class="border p-1">Managers could not produce training logs for Q3.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <p class="mt-2 text-xs text-gray-500"><i>We will build this section ourselves in the Simulation tab.</i></p>
                                </div>

                                <div id="sar-part-risk" class="sar-detail-view hidden">
                                    <h4 class="text-lg font-bold text-blue-900 mb-2">5. Risk Recommendation</h4>
                                    <p class="text-sm text-gray-600 mb-4">The assessor's final verdict.</p>
                                    <p class="text-sm text-gray-700">
                                        For <strong>CMMC</strong>, this translates to a certification recommendation. 
                                        <br><br>
                                        <strong>Conditional Level 2:</strong> Allowed if &lt; 20% of controls are failed, and NONE are 5-point weighted controls. Requires <strong>POA&amp;M</strong> closeout in 180 days.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="switchTab('overview')" class="text-gray-600 hover:text-gray-900">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Back
                    </button>
                    <button onclick="switchTab('executive-summary')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-md">
                        Next: Build Summary <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- SECTION 3: EXECUTIVE SUMMARY -->
            <div id="executive-summary" class="tab-content max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">SAR Section 1: Executive Summary Builder</h2>

                <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                    <p class="text-gray-600 mb-6">
                        The <strong>Executive Summary</strong> provides the high-level context, system scope, and overall assessment outcome for leadership review. Complete the fields below to generate the mandatory introductory content for your SAR.
                    </p>

                    <form id="summaryForm" class="space-y-6">
                        <h3 class="text-xl font-semibold text-blue-800 border-b pb-2 mb-4"><i class="fa-solid fa-building mr-2"></i> Organization Details (OSC)</h3>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label for="orgName" class="block text-sm font-medium text-gray-700 mb-1">Organization Name</label>
                                <input type="text" id="orgName" oninput="renderExecutiveSummary()" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Defense Contractor Solutions Inc." value="CMMC Testing Corp">
                            </div>
                            <div>
                                <label for="orgLocation" class="block text-sm font-medium text-gray-700 mb-1">Primary Location</label>
                                <input type="text" id="orgLocation" oninput="renderExecutiveSummary()" class="w-full border border-gray-300 rounded-lg p-2 text-sm" placeholder="Dallas, TX" value="Springfield, VA">
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label for="employeeCount" class="block text-sm font-medium text-gray-700 mb-1">Number of Employees (In Scope)</label>
                                <input type="number" id="employeeCount" oninput="renderExecutiveSummary()" class="w-full border border-gray-300 rounded-lg p-2 text-sm" placeholder="e.g., 50" value="85">
                            </div>
                            <div>
                                <label for="businessType" class="block text-sm font-medium text-gray-700 mb-1">Business Type</label>
                                <select id="businessType" onchange="renderExecutiveSummary()" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="SME">Small/Medium Enterprise (SME)</option>
                                    <option value="Large">Large Prime Contractor</option>
                                    <option value="C3PAO">C3PAO</option>
                                </select>
                            </div>
                        </div>

                        <h3 class="text-xl font-semibold text-blue-800 border-b pb-2 mb-4 pt-4"><i class="fa-solid fa-file-shield mr-2"></i> Assessment Details</h3>
                        
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label for="assessmentDate" class="block text-sm font-medium text-gray-700 mb-1">Assessment Completion Date</label>
                                <input type="date" id="assessmentDate" onchange="renderExecutiveSummary()" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                            </div>
                            <div>
                                <label for="cmmcLevel" class="block text-sm font-medium text-gray-700 mb-1">CMMC Assessment Level</label>
                                <select id="cmmcLevel" onchange="renderExecutiveSummary()" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Level 1">Level 1 (FCI)</option>
                                    <option value="Level 2">Level 2 (CUI)</option>
                                    <option value="Level 3">Level 3 (High Value CUI)</option>
                                </select>
                            </div>
                            <div>
                                <label for="assessmentType" class="block text-sm font-medium text-gray-700 mb-1">Assessment Type</label>
                                <select id="assessmentType" onchange="renderExecutiveSummary()" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Initial">Initial Certification Assessment</option>
                                    <option value="Annual">Annual Reassessment</option>
                                    <option value="POA&M Closeout">POA&M Closeout Review</option>
                                </select>
                            </div>
                        </div>

                        <p class="mt-6 text-sm text-gray-500 bg-gray-50 p-3 rounded">
                            <i class="fa-solid fa-lightbulb text-yellow-600 mr-2"></i>
                            Score and Key Findings will be automatically inserted into the final SAR template (in the <strong>Write a SAR</strong> tab) once you complete the control assessments.
                        </p>
                    </form>
                </div>
                
                <div class="mt-8 flex justify-end">
                    <button onclick="switchTab('methodology-scope')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-md">
                        Next: Define Methodology <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- SECTION 4: METHODOLOGY & SCOPE (NEW) -->
            <div id="methodology-scope" class="tab-content max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">SAR Section 2: Methodology & Scope Builder</h2>

                <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-xl font-semibold text-blue-800 border-b pb-2 mb-4"><i class="fa-solid fa-vial mr-2"></i> Assessment Approach</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Select the evaluation methods employed during the assessment. This information will be used to generate the <strong>Assessment Approach</strong> section of the report.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer transition">
                            <input type="checkbox" id="chkApproachDoc" onchange="renderMethodology()" class="form-checkbox text-blue-600 h-5 w-5" checked>
                            <span class="text-sm text-gray-700"><strong>Document Review:</strong> System Security Plan (SSP), policies, procedures, and technical documentation.</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer transition">
                            <input type="checkbox" id="chkApproachInterview" onchange="renderMethodology()" class="form-checkbox text-blue-600 h-5 w-5" checked>
                            <span class="text-sm text-gray-700"><strong>Interviews:</strong> Key personnel responsible for security controls.</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer transition">
                            <input type="checkbox" id="chkApproachTest" onchange="renderMethodology()" class="form-checkbox text-blue-600 h-5 w-5" checked>
                            <span class="text-sm text-gray-700"><strong>System Testing:</strong> Technical validation of security controls and configurations.</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer transition">
                            <input type="checkbox" id="chkApproachInspect" onchange="renderMethodology()" class="form-checkbox text-blue-600 h-5 w-5">
                            <span class="text-sm text-gray-700"><strong>Physical Inspection:</strong> On-site evaluation of physical security measures.</span>
                        </label>
                    </div>

                    <h3 class="text-xl font-semibold text-blue-800 border-b pb-2 mb-4 pt-8"><i class="fa-solid fa-boxes-stacked mr-2"></i> Assessment Scope (Asset Inventory)</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Define the <strong>CUI</strong> and <strong>Security Protection Assets (SPAs)</strong> that are in scope for this assessment.
                    </p>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- CUI Assets -->
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h4 class="font-bold text-gray-800 mb-3">In-Scope CUI Assets</h4>
                            <div class="flex space-x-2 mb-3">
                                <input type="text" id="cuiAssetName" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="e.g., Primary Data Server (CUI-001)">
                                <button onclick="addCuiAsset()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded transition"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <ul id="cuiAssetList" class="asset-list bg-white rounded border max-h-48 overflow-y-auto text-sm">
                                <li class="p-4 text-center text-gray-400 italic">No CUI assets defined.</li>
                            </ul>
                        </div>
                        
                        <!-- SPAs -->
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h4 class="font-bold text-gray-800 mb-3">Security Protection Assets (SPAs)</h4>
                            <div class="flex space-x-2 mb-3">
                                <input type="text" id="spaAssetName" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="e.g., Enterprise Firewall (SPA-001)">
                                <button onclick="addSpaAsset()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded transition"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <ul id="spaAssetList" class="asset-list bg-white rounded border max-h-48 overflow-y-auto text-sm">
                                <li class="p-4 text-center text-gray-400 italic">No SPAs defined.</li>
                            </ul>
                        </div>
                    </div>

                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="switchTab('executive-summary')" class="text-gray-600 hover:text-gray-900">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Back
                    </button>
                    <button onclick="switchTab('team-credentials')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-md">
                        Next: Define Team Credentials <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>


            <!-- SECTION 5: ASSESSMENT TEAM CREDENTIALS -->
            <div id="team-credentials" class="tab-content max-w-5xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">SAR Section 3: Assessment Team Credentials</h2>
                
                <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                    <p class="text-gray-600 mb-6">
                        This section ensures the credibility and authority of the audit by documenting the <strong>Certified Third-Party Assessment Organization (C3PAO)</strong> and the qualifications of all personnel involved.
                    </p>

                    <h3 class="text-xl font-semibold text-blue-800 border-b pb-2 mb-4"><i class="fa-solid fa-building-user mr-2"></i> C3PAO Information</h3>
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="c3paoName" class="block text-sm font-medium text-gray-700 mb-1">C3PAO Organization Name</label>
                            <input type="text" id="c3paoName" oninput="renderTeamCredentials()" class="w-full border border-gray-300 rounded-lg p-2 text-sm" placeholder="SecureAssess C3PAO LLC" value="SecureAssess C3PAO LLC">
                        </div>
                        <div>
                            <label for="c3paoAuthNum" class="block text-sm font-medium text-gray-700 mb-1">C3PAO Authorization Number</label>
                            <input type="text" id="c3paoAuthNum" oninput="renderTeamCredentials()" class="w-full border border-gray-300 rounded-lg p-2 text-sm" placeholder="C3PAO-2025-001" value="C3PAO-2025-001">
                        </div>
                        <div class="md:col-span-2">
                            <label for="isoCert" class="block text-sm font-medium text-gray-700 mb-1">ISO 17020 Certification Status</label>
                            <input type="text" id="isoCert" oninput="renderTeamCredentials()" class="w-full border border-gray-300 rounded-lg p-2 text-sm" placeholder="Valid through December 2026" value="Valid through December 2026">
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-blue-800 border-b pb-2 mb-4 pt-4"><i class="fa-solid fa-users mr-2"></i> Assessment Team Members</h3>
                    <p class="text-sm text-gray-600 mb-4">Add the certified members who participated in the <strong>Level 2</strong> assessment.</p>

                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                            <div class="md:col-span-1">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Name</label>
                                <input type="text" id="teamMemberName" class="w-full border rounded p-2 text-sm" placeholder="e.g. Jane Doe">
                            </div>
                            <div class="md:col-span-1">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Role</label>
                                <select id="teamMemberRole" class="w-full border rounded p-2 text-sm">
                                    <option value="Lead Certified CMMC Assessor (CCA)">Lead CCA</option>
                                    <option value="Certified CMMC Professional (CCP)">CCP</option>
                                    <option value="Quality Control Lead">QC Lead</option>
                                    <option value="CMMC Assessor Candidate">Candidate</option>
                                </select>
                            </div>
                            <div class="md:col-span-1">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Certification ID</label>
                                <input type="text" id="teamMemberCert" class="w-full border rounded p-2 text-sm" placeholder="CCA-2024-156">
                            </div>
                            <div class="md:col-span-1">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Experience</label>
                                <input type="text" id="teamMemberExp" class="w-full border rounded p-2 text-sm" placeholder="8 years cybersecurity">
                            </div>
                            <div class="md:col-span-1">
                                <button onclick="addTeamMember()" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded transition">
                                    <i class="fa-solid fa-plus mr-1"></i> Add Member
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Team Table -->
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full text-sm text-left team-table">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2">Name</th>
                                    <th class="px-4 py-2">Role</th>
                                    <th class="px-4 py-2">Certification</th>
                                    <th class="px-4 py-2">Experience</th>
                                    <th class="px-4 py-2 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="teamTableBody">
                                <!-- Default members added by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="switchTab('methodology-scope')" class="text-gray-600 hover:text-gray-900">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Back
                    </button>
                    <button onclick="switchTab('simulation')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-md">
                        Next: Go to SAR Lab <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- SECTION 6: LAB / SIMULATION -->
            <div id="simulation" class="tab-content max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">SAR Section 4: Lab - Assessment Findings (SRTM)</h2>
                
                <div class="w-full flex flex-col gap-4">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fa-solid fa-pen-to-square text-blue-600 mr-2"></i> Assessor Input Form
                        </h3>
                        <p class="text-xs text-gray-500 mb-4">Select a control, determine its status (<strong>MET/NOT MET</strong>), and log your observation/finding.</p>
                        
                        <form id="sarForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Control ID</label>
                                <select id="controlId" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" onchange="updateControlDesc(); checkArtifactAvailability();">
                                    <option value="AC.L2-3.1.1">AC.L2-3.1.1 - Account Management</option>
                                    <option value="AC.L2-3.1.2">AC.L2-3.1.2 - Wireless Access</option>
                                    <option value="AT.L2-3.2.1">AT.L2-3.2.1 - Awareness Training</option>
                                    <option value="AU.L2-3.3.1">AU.L2-3.3.1 - System Auditing</option>
                                    <option value="IA.L2-3.5.1">IA.L2-3.5.1 - Identification</option>
                                    <option value="IR.L2-3.6.1">IR.L2-3.6.1 - Incident Handling</option>
                                    <option value="MP.L2-3.8.1">MP.L2-3.8.1 - Media Protection</option>
                                    <option value="PE.L2-3.10.1">PE.L2-3.10.1 - Physical Access</option>
                                </select>
                                <p id="controlDesc" class="text-xs text-gray-500 mt-1 italic bg-gray-50 p-2 rounded border border-gray-100">Limit information system access to authorized users.</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Assessment Status</label>
                                <select id="status" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" onchange="toggleRemediation()">
                                    <option value="MET">Met (Satisfied)</option>
                                    <option value="NOT MET">Not Met (Deficiency)</option>
                                    <option value="N/A">N/A (Not Applicable)</option>
                                </select>
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="block text-sm font-medium text-gray-700">Observation / Evidentiary Matter</label>
                                </div>
                                <textarea id="observation" rows="3" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g., Examined AD Group Policy settings; Interviewed SysAdmin. Artifacts: GPO Screenshot 1.2"></textarea>
                            </div>

                            <div id="remediationGroup" class="hidden">
                                <label class="block text-sm font-medium text-red-700 mb-1">Risk / Weakness Description</label>
                                <textarea id="riskDesc" rows="2" class="w-full border border-red-300 bg-red-50 rounded-lg p-2 text-sm focus:ring-2 focus:ring-red-500 outline-none" placeholder="Describe why this failed and the risk to CUI..."></textarea>
                            </div>

                            <button type="button" onclick="addSarEntry()" class="w-full bg-blue-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-900 transition transform active:scale-95">
                                Log Finding
                            </button>
                        </form>
                    </div>

                    <!-- Mini Stats -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-around text-center">
                        <div>
                            <div id="countMet" class="text-2xl font-bold text-green-600">0</div>
                            <div class="text-xs text-gray-500">Met</div>
                        </div>
                        <div>
                            <div id="countNotMet" class="text-2xl font-bold text-red-600">0</div>
                            <div class="text-xs text-gray-500">Not Met</div>
                        </div>
                        <div>
                            <div id="score" class="text-2xl font-bold text-blue-600">0</div>
                            <div class="text-xs text-gray-500">Controls Assessed</div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <h4 class="font-bold text-gray-800 mb-2">Logged Findings Summary</h4>
                        <div class="max-h-64 overflow-y-auto">
                            <ul id="loggedFindingsList" class="list-disc list-inside text-sm text-gray-700 space-y-1">
                                <li class="text-gray-400 italic">No findings logged yet.</li>
                            </ul>
                        </div>
                        <div class="flex justify-between mt-4">
                            <button onclick="clearReport()" class="text-xs text-red-600 hover:text-red-800 underline">Clear All Findings</button>
                            <button onclick="switchTab('risk-conclusion')" class="bg-blue-600 text-white px-4 py-1 text-sm rounded-lg hover:bg-blue-700 transition shadow-md">
                                Next: Finalize Conclusion <i class="fa-solid fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECTION 7: RISK & CONCLUSION -->
            <div id="risk-conclusion" class="tab-content max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">SAR Section 5: Risk & Conclusion</h2>

                <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                    <p class="text-gray-600 mb-6">
                        This section finalizes the assessment by analyzing the risk of the deficiencies, developing a remedial plan (<strong>POA&amp;M</strong>), and issuing the final certification decision.
                    </p>

                    <h3 class="text-xl font-semibold text-red-800 border-b pb-2 mb-4"><i class="fa-solid fa-triangle-exclamation mr-2"></i> Risk and Impact Analysis</h3>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="riskLikelihood" class="block text-sm font-medium text-gray-700 mb-1">Overall Likelihood of Exploitation</label>
                            <select id="riskLikelihood" onchange="renderRiskConclusion()" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="Low">Low</option>
                                <option value="Moderate">Moderate</option>
                                <option value="High">High</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Probability the vulnerability will be successfully exploited.</p>
                        </div>
                        <div>
                            <label for="riskImpact" class="block text-sm font-medium text-gray-700 mb-1">Overall Impact to CUI</label>
                            <select id="riskImpact" onchange="renderRiskConclusion()" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="Low">Low (Minor disruption)</option>
                                <option value="Moderate">Moderate (Significant CUI breach/loss)</option>
                                <option value="High">High (Severe, critical impact to national security)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Severity of harm resulting from the successful exploitation.</p>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-blue-800 border-b pb-2 mb-4 pt-4"><i class="fa-solid fa-list-check mr-2"></i> Plan of Action & Milestones (POA&M)</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Document the remediation steps for the controls marked <strong>NOT MET</strong> in the SAR Lab. This is required for a Conditional Pass.
                    </p>
                    
                    <div id="poamBuilder" class="space-y-4">
                        <!-- Dynamic POA&M Input will be rendered here based on NOT MET findings -->
                        <div class="bg-yellow-50 p-4 rounded-lg text-yellow-800 text-sm border-l-4 border-yellow-400">
                            POA&M fields will appear here once you mark a control as "NOT MET" in the <strong>Lab: Write a SAR</strong> tab.
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-green-800 border-b pb-2 mb-4 pt-8"><i class="fa-solid fa-lightbulb mr-2"></i> Improvement Recommendations</h3>
                    <textarea id="improvementRecs" oninput="renderRiskConclusion()" rows="4" class="w-full border border-gray-300 rounded-lg p-2 text-sm" placeholder="Provide strategic, non-POA&M related recommendations, such as 'Implement a continuous monitoring solution for all CUI assets' or 'Review third-party vendor access controls.'"></textarea>

                </div>

                <div class="mt-8 flex justify-end">
                    <button onclick="switchTab('final-report')" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition shadow-md">
                        Generate Final Report <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- SECTION 8: FINAL REPORT -->
            <div id="final-report" class="tab-content max-w-6xl mx-auto h-full">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">SAR Section 6: Final Report</h2>
                
                <div class="w-full flex flex-col lg:flex-row h-full gap-6 pb-20">

                    <!-- Export Panel -->
                    <div class="w-full lg:w-1/3 flex flex-col gap-4 hidden-print btn-print-area">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fa-solid fa-download text-blue-600 mr-2"></i> Export Options
                            </h3>
                            <p class="text-sm text-gray-600 mb-4">Generate exportable versions of the report for submission and archiving.</p>
                            
                            <button onclick="printReport()" class="w-full flex items-center justify-center space-x-2 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition transform active:scale-95 mb-3">
                                <i class="fa-solid fa-print"></i> <span>Print / Save as PDF</span>
                            </button>

                            <button onclick="downloadCSV()" class="w-full flex items-center justify-center space-x-2 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition transform active:scale-95">
                                <i class="fa-solid fa-file-csv"></i> <span>Download Findings (CSV)</span>
                            </button>
                        </div>
                        <div class="mt-auto flex justify-end">
                             <button onclick="switchTab('risk-conclusion')" class="text-gray-600 hover:text-gray-900">
                                <i class="fa-solid fa-arrow-left mr-2"></i> Back to Conclusion
                            </button>
                        </div>
                    </div>

                    <!-- Output Preview (Print Area) -->
                    <div class="w-full lg:w-2/3 bg-white rounded-xl shadow paper-shadow flex flex-col border border-gray-200 print-area">
                        <div class="bg-gray-100 p-4 border-b border-gray-300 flex justify-between items-center rounded-t-xl hidden-print">
                            <div class="flex items-center">
                                <i class="fa-regular fa-file-pdf text-red-500 mr-2 text-lg"></i>
                                <div>
                                    <h3 class="font-bold text-gray-800 leading-tight">Final Security Assessment Report Preview</h3>
                                    <p class="text-xs text-gray-500">Review for accuracy before printing/exporting.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-8 font-serif text-sm leading-relaxed report-page" id="finalReportContent">
                            <!-- Report content is loaded here by renderFinalReport() -->
                            <p class="text-center text-gray-500 italic p-10">Report content loading...</p>
                        </div>
                    </div>

                </div>
            </div>
            
        </main>
    </div>

    <script>
        // --- Data for Simulation ---
        const controlDescriptions = {
            "AC.L2-3.1.1": "Limit information system access to authorized users, processes acting on behalf of authorized users, or devices (including other information systems).",
            "AC.L2-3.1.2": "Limit information system access to the types of transactions and functions that authorized users are permitted to execute.",
            "AT.L2-3.2.1": "Ensure that managers, systems administrators, and users of organizational information systems are made aware of the security risks associated with their activities.",
            "AU.L2-3.3.1": "Create and retain system audit logs and records to the extent needed to enable the monitoring, analysis, investigation, and reporting of unlawful or unauthorized system activity.",
            "IA.L2-3.5.1": "Identify information system users, processes acting on behalf of users, or devices.",
            "IR.L2-3.6.1": "Establish an operational incident-handling capability for organizational information systems that includes preparation, detection, analysis, containment, recovery, and user response activities.",
            "MP.L2-3.8.1": "Protect (i.e., physically control and securely store) system media containing CUI, both paper and digital.",
            "PE.L2-3.10.1": "Limit physical access to organizational information systems, equipment, and the respective operating environments to authorized individuals."
        };

        // --- Global Data Stores ---
        let teamMembers = [
            { id: 1, name: "Sarah Mitchell", role: "Lead Certified CMMC Assessor (CCA)", cert: "CCA-2024-156", exp: "8 years cybersecurity, 3 years CMMC" },
            { id: 2, name: "James Rodriguez", role: "Certified CMMC Professional (CCP)", cert: "CCP-2024-342", exp: "12 years IT security, 2 years CMMC" },
            { id: 3, name: "Dr. Emily Chen", role: "Quality Control Lead", cert: "CCA-2023-089", exp: "15 years security assessments" }
        ];
        let accessDb = []; // Placeholder, retained to avoid errors if logic used it
        let cuiAssets = [];
        let spaAssets = [];
        let stats = { met: 0, notMet: 0, total: 0 };
        let sarFindings = []; // Stores all recorded SAR entries
        let poamEntries = {}; // Stores POA&M details for NOT MET findings

        // --- Navigation Logic ---
        function switchTab(tabId) {
            // Re-render conclusion content if we're moving to the conclusion tab
            if (tabId === 'risk-conclusion') {
                renderPoamBuilder(); // Ensure POA&M input fields are up to date
                renderRiskConclusion(); // Ensure conclusion output is up to date when entering the tab
            }
            if (tabId === 'simulation') {
                // Ensure the list of logged findings is up to date when entering the lab
                renderLoggedFindingsList();
            }
            if (tabId === 'team-credentials') {
                renderTeamCredentials();
            }
            if (tabId === 'final-report') {
                renderFinalReport();
            }
            
            // Hide all content
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Show selected
            document.getElementById(tabId).classList.add('active');
            
            const btn = document.getElementById('btn-' + tabId);
            if(btn) {
                btn.classList.add('active');
            }
        }

        function showSarPart(partId) {
            // Hide all parts in Deep Dive
            document.querySelectorAll('.sar-detail-view').forEach(el => el.classList.add('hidden'));
            const partEl = document.getElementById('sar-part-' + partId);
            if(partEl) {
                partEl.classList.remove('hidden');
            }
        }

        // --- Executive Summary Data Logic ---
        function getExecutiveSummaryData() {
            // Retrieve data from form, using default values if elements don't exist yet (e.g., initial load)
            const orgNameElement = document.getElementById('orgName');
            const orgName = orgNameElement ? orgNameElement.value : 'CMMC Testing Corp';
            
            const orgLocationElement = document.getElementById('orgLocation');
            const orgLocation = orgLocationElement ? orgLocationElement.value : 'Springfield, VA';

            const employeeCountElement = document.getElementById('employeeCount');
            const employeeCount = employeeCountElement ? employeeCountElement.value : '85';
            
            const businessTypeElement = document.getElementById('businessType');
            const businessType = businessTypeElement && businessTypeElement.options[businessTypeElement.selectedIndex]
                ? businessTypeElement.options[businessTypeElement.selectedIndex].text : 'SME';

            const assessmentDateRaw = document.getElementById('assessmentDate');
            const assessmentDateValue = assessmentDateRaw ? assessmentDateRaw.value : null;
            // Robust date parsing using 'T00:00:00' to avoid timezone issues with date inputs
            const assessmentDate = assessmentDateValue 
                ? new Date(assessmentDateValue + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) 
                : new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            const cmmcLevelElement = document.getElementById('cmmcLevel');
            const cmmcLevel = cmmcLevelElement ? cmmcLevelElement.value : 'Level 2';
            
            const assessmentTypeElement = document.getElementById('assessmentType');
            const assessmentType = assessmentTypeElement ? assessmentTypeElement.value : 'Initial';
            
            let resultText = "PENDING ASSESSMENT";
            let statusColor = 'text-gray-600';

            if (stats.total > 0) {
                if (stats.notMet === 0) {
                    resultText = "FINAL CERTIFICATION RECOMMENDED";
                    statusColor = 'text-green-700';
                } else {
                    resultText = `CONDITIONAL CERTIFICATION (POA&M Required: ${stats.notMet} findings)`;
                    statusColor = 'text-yellow-600';
                }
            }
            
            return {
                orgName, orgLocation, employeeCount, businessType,
                assessmentDate, cmmcLevel, assessmentType,
                resultText, statusColor
            };
        }

        function renderExecutiveSummary() {
            const data = getExecutiveSummaryData();
            
            // Update report header elements (used in final report)
            const reportOrgNameEl = document.getElementById('reportOrgName');
            if (reportOrgNameEl) reportOrgNameEl.innerText = data.orgName;

            const reportDateEl = document.getElementById('reportDate');
            if (reportDateEl) reportDateEl.innerText = data.assessmentDate;

            // Generate content HTML
            return `
                <h4 class="font-bold text-lg mb-2 uppercase border-b border-gray-400">1.0 Executive Summary</h4>
                <div class="p-4 bg-gray-50 rounded-lg mb-6">
                    <p class="text-xs font-bold uppercase text-gray-600">Assessment Result</p>
                    <p class="text-xl font-extrabold ${data.statusColor}">${data.resultText}</p>
                </div>

                <h5 class="font-bold text-md mb-1 text-blue-900">1.1 Organization Information (OSC)</h5>
                <table class="w-full text-xs mb-4">
                    <tr><td class="w-1/3 py-1">Organization Name:</td><td class="font-semibold">${data.orgName}</td></tr>
                    <tr><td class="w-1/3 py-1">Primary Location:</td><td class="font-semibold">${data.orgLocation}</td></tr>
                    <tr><td class="w-1/3 py-1">Business Type:</td><td class="font-semibold">${data.businessType}</td></tr>
                    <tr><td class="w-1/3 py-1">In-Scope Employees:</td><td class="font-semibold">${data.employeeCount}</td></tr>
                </table>
                
                <h5 class="font-bold text-md mb-1 text-blue-900">1.2 Assessment Scope & Status</h5>
                <table class="w-full text-xs mb-6">
                    <tr><td class="w-1/3 py-1">Assessment Date:</td><td class="font-semibold">${data.assessmentDate}</td></tr>
                    <tr><td class="w-1/3 py-1">CMMC Level Assessed:</td><td class="font-semibold">${data.cmmcLevel}</td></tr>
                    <tr><td class="w-1/3 py-1">Assessment Type:</td><td class="font-semibold">${data.assessmentType}</td></tr>
                </table>
            `;
        }

        // --- Methodology & Scope Logic ---
        
        function getMethodologyData() {
            const approaches = [
                { id: 'chkApproachDoc', text: '<strong>Document Review:</strong> System Security Plan (SSP), policies, procedures, and technical documentation.' },
                { id: 'chkApproachInterview', text: '<strong>Interviews:</strong> Key personnel responsible for security control implementation.' },
                { id: 'chkApproachTest', text: '<strong>System Testing:</strong> Technical validation of security controls and configurations.' },
                { id: 'chkApproachInspect', text: '<strong>Physical Inspection:</strong> On-site evaluation of physical security measures.' },
            ];

            const selectedApproaches = approaches
                .filter(a => {
                    const el = document.getElementById(a.id);
                    return el && el.checked;
                })
                .map(a => `<li>${a.text}</li>`)
                .join('');
            
            return {
                selectedApproaches,
                cuiCount: cuiAssets.length,
                spaCount: spaAssets.length,
                cuiList: cuiAssets,
                spaList: spaAssets
            };
        }

        function renderMethodology() {
            const data = getMethodologyData();
            
            // Generate content HTML
            return `
                <h4 class="font-bold text-lg mb-2 uppercase border-b border-gray-400">2.0 Assessment Methodology & Scope</h4>
                <h5 class="font-bold text-md mb-2 text-blue-900">2.1 Assessment Approach</h5>
                <p class="text-xs text-gray-700 mb-4">The assessment employed the following evaluation techniques, based on NIST SP 800-171A:</p>
                <ul class="list-disc list-inside text-xs text-gray-700 ml-4 space-y-1 mb-6">
                    ${data.selectedApproaches.length > 0 ? data.selectedApproaches : '<li>No assessment approaches selected.</li>'}
                </ul>

                <h5 class="font-bold text-md mb-2 text-blue-900">2.2 Assessment Scope (Asset Inventory)</h5>
                <p class="text-xs text-gray-700 mb-2">The assessment boundary included the following CUI and Security Protection Assets:</p>
                
                <h5 class="font-bold text-sm mb-1 mt-3 text-blue-800">CUI Assets (${data.cuiCount} Total)</h5>
                <ul class="list-disc list-inside text-xs text-gray-700 ml-4 space-y-1 mb-4">
                    ${data.cuiList.length > 0 ? data.cuiList.map(a => `<li>${a}</li>`).join('') : '<li>No CUI assets defined.</li>'}
                </ul>

                <h5 class="font-bold text-sm mb-1 text-blue-800">Security Protection Assets (SPAs) (${data.spaCount} Total)</h5>
                <ul class="list-disc list-inside text-xs text-gray-700 ml-4 space-y-1 mb-6">
                    ${data.spaList.length > 0 ? data.spaList.map(a => `<li>${a}</li>`).join('') : '<li>No Security Protection Assets defined.</li>'}
                </ul>
            `;
        }
        
        function addCuiAsset() {
            const nameInput = document.getElementById('cuiAssetName');
            const name = nameInput ? nameInput.value.trim() : '';
            if (name) {
                cuiAssets.push(name);
                if (nameInput) nameInput.value = '';
                renderAssetLists();
            }
        }

        function removeCuiAsset(index) {
            cuiAssets.splice(index, 1);
            renderAssetLists();
        }

        function addSpaAsset() {
            const nameInput = document.getElementById('spaAssetName');
            const name = nameInput ? nameInput.value.trim() : '';
            if (name) {
                spaAssets.push(name);
                if (nameInput) nameInput.value = '';
                renderAssetLists();
            }
        }

        function removeSpaAsset(index) {
            spaAssets.splice(index, 1);
            renderAssetLists();
        }

        function renderAssetLists() {
            const cuiListEl = document.getElementById('cuiAssetList');
            if (cuiListEl) {
                cuiListEl.innerHTML = cuiAssets.length > 0 ? cuiAssets.map((asset, index) => `
                    <li>
                        <span class="text-gray-700">${asset}</span>
                        <button class="remove-btn" onclick="removeCuiAsset(${index})">Remove</button>
                    </li>
                `).join('') : '<li class="p-4 text-center text-gray-400 italic">No CUI assets defined.</li>';
            }

            const spaListEl = document.getElementById('spaAssetList');
            if (spaListEl) {
                spaListEl.innerHTML = spaAssets.length > 0 ? spaAssets.map((asset, index) => `
                    <li>
                        <span class="text-gray-700">${asset}</span>
                        <button class="remove-btn" onclick="removeSpaAsset(${index})">Remove</button>
                    </li>
                `).join('') : '<li class="p-4 text-center text-gray-400 italic">No SPAs defined.</li>';
            }

            // The content for the report section is generated dynamically in renderFinalReport
            // No direct update needed here, just keep the data stores current.
        }

        // --- Team Credentials Logic ---
        function addTeamMember() {
            const nameEl = document.getElementById('teamMemberName');
            const roleEl = document.getElementById('teamMemberRole');
            const certEl = document.getElementById('teamMemberCert');
            const expEl = document.getElementById('teamMemberExp');

            const name = nameEl.value.trim();
            const role = roleEl.value;
            const cert = certEl.value.trim();
            const exp = expEl.value.trim();

            if (name && role) {
                const newId = teamMembers.length ? Math.max(...teamMembers.map(m => m.id)) + 1 : 1;
                teamMembers.push({ id: newId, name, role, cert, exp });
                
                nameEl.value = '';
                certEl.value = '';
                expEl.value = '';
                roleEl.value = 'Lead Certified CMMC Assessor (CCA)';
                
                renderTeamCredentials();
            }
        }

        function removeTeamMember(id) {
            teamMembers = teamMembers.filter(m => m.id !== id);
            renderTeamCredentials();
        }

        function getTeamCredentialsData() {
            const c3paoNameEl = document.getElementById('c3paoName');
            const c3paoAuthNumEl = document.getElementById('c3paoAuthNum');
            const isoCertEl = document.getElementById('isoCert');

            return {
                c3paoName: c3paoNameEl ? c3paoNameEl.value : 'SecureAssess C3PAO LLC',
                c3paoAuthNum: c3paoAuthNumEl ? c3paoAuthNumEl.value : 'C3PAO-2025-001',
                isoCert: isoCertEl ? isoCertEl.value : 'Valid through December 2026',
                members: teamMembers
            };
        }

        function renderTeamCredentials() {
            const data = getTeamCredentialsData();
            const tbody = document.getElementById('teamTableBody');

            if (tbody) {
                tbody.innerHTML = data.members.map(m => `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-4 py-2 font-medium text-gray-900">${m.name}</td>
                        <td class="px-4 py-2">${m.role}</td>
                        <td class="px-4 py-2 text-gray-600">${m.cert || 'N/A'}</td>
                        <td class="px-4 py-2 text-gray-600">${m.exp || 'Not documented'}</td>
                        <td class="px-4 py-2 text-center">
                            <button class="font-medium text-red-600 hover:underline text-xs" onclick="removeTeamMember(${m.id})">Remove</button>
                        </td>
                    </tr>
                `).join('') || `<tr><td colspan="5" class="p-4 text-center text-gray-400 italic">No assessment members added.</td></tr>`;
            }

            // Generate content HTML for final report
            return `
                <h4 class="font-bold text-lg mb-2 uppercase border-b border-gray-400">3.0 Assessment Team Credentials</h4>
                <h5 class="font-bold text-md mb-1 text-blue-900">3.1 C3PAO Information</h5>
                <table class="w-full text-xs mb-4">
                    <tr><td class="w-1/3 py-1">Assessment Organization:</td><td class="font-semibold">${data.c3paoName}</td></tr>
                    <tr><td class="w-1/3 py-1">C3PAO Authorization Number:</td><td class="font-semibold">${data.c3paoAuthNum}</td></tr>
                    <tr><td class="w-1/3 py-1">ISO 17020 Certification:</td><td class="font-semibold">${data.isoCert}</td></tr>
                </table>
                
                <h5 class="font-bold text-md mb-2 text-blue-900">3.2 Assessment Team Members (${data.members.length} Total)</h5>
                <table class="w-full text-xs border-collapse border border-gray-300 sar-table mb-6">
                    <thead>
                        <tr>
                            <th class="border border-black p-2 text-left w-1/4">Name</th>
                            <th class="border border-black p-2 text-left w-1/4">Role</th>
                            <th class="border border-black p-2 text-left w-1/4">Certification</th>
                            <th class="border border-black p-2 text-left w-1/4">Experience</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.members.map(m => `
                            <tr>
                                <td class="border border-black p-2">${m.name}</td>
                                <td class="border border-black p-2">${m.role}</td>
                                <td class="border border-black p-2">${m.cert || 'N/A'}</td>
                                <td class="border border-black p-2">${m.exp || 'Not documented'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }


        // --- Simulation Logic ---
        function updateControlDesc() {
            const controlElement = document.getElementById('controlId');
            const id = controlElement ? controlElement.value : 'AC.L2-3.1.1';
            const descElement = document.getElementById('controlDesc');
            if(descElement) {
                descElement.innerText = controlDescriptions[id] || 'Description not found.';
            }
        }

        function checkArtifactAvailability() {
            // Placeholder: no external artifact logic needed for current scope
        }

        function toggleRemediation() {
            const status = document.getElementById('status').value;
            const group = document.getElementById('remediationGroup');
            if (group) {
                if (status === 'NOT MET') {
                    group.classList.remove('hidden');
                } else {
                    group.classList.add('hidden');
                }
            }
        }

        function addSarEntry() {
            const controlId = document.getElementById('controlId').value;
            const status = document.getElementById('status').value;
            const obs = document.getElementById('observation').value;
            const risk = document.getElementById('riskDesc').value;
            
            // Check if control already exists in sarFindings
            const existingIndex = sarFindings.findIndex(f => f.controlId === controlId);

            const newEntry = {
                controlId,
                desc: controlDescriptions[controlId],
                status,
                observation: obs,
                deficiency: status === 'NOT MET' ? risk : '',
            };

            if (existingIndex !== -1) {
                // Update existing entry
                sarFindings[existingIndex] = newEntry;
            } else {
                // Add new entry
                sarFindings.push(newEntry);
            }
            
            // Update POA&M store if status is NOT MET or remove if it's MET/N/A
            if (status === 'NOT MET') {
                if (!poamEntries[controlId]) {
                    poamEntries[controlId] = {
                        controlId: controlId,
                        deficiency: newEntry.deficiency, // Use the deficiency from the finding for initial POA&M
                        remediation: '',
                        responsible: '',
                        milestone: ''
                    };
                } else {
                    // Update deficiency text if it was changed
                    poamEntries[controlId].deficiency = risk; 
                }
            } else {
                delete poamEntries[controlId];
            }


            // Re-render logged findings list and stats
            renderLoggedFindingsList();
            updateStats();
            
            // Reset form
            document.getElementById('observation').value = '';
            document.getElementById('riskDesc').value = '';
            
            const remediationGroupEl = document.getElementById('remediationGroup');
            if (remediationGroupEl) remediationGroupEl.classList.add('hidden');
            
            const statusEl = document.getElementById('status');
            if (statusEl) statusEl.value = 'MET';
        }
        
        function renderSarTableContent() {
            if (sarFindings.length === 0) {
                 return `
                    <tr id="emptyState">
                        <td colspan="4" class="p-8 text-center text-gray-400 italic bg-gray-50">
                            No findings recorded yet. Use the Assessor Input Form to assess controls.
                        </td>
                    </tr>`;
            }

            return sarFindings.map(f => {
                let observationText = f.observation.replace(/\n/g, '<br>');
                if (f.status === 'NOT MET' && f.deficiency) {
                    observationText += `<br><span class='text-red-700 mt-1 block'><strong>Deficiency:</strong> ${f.deficiency}</span>`;
                }
                
                let statusClass = "status-met";
                if(f.status === 'NOT MET') statusClass = "status-not-met";
                if(f.status === 'N/A') statusClass = "status-na";

                return `
                    <tr>
                        <td class="border border-black p-2 align-top font-mono font-bold">${f.controlId}</td>
                        <td class="border border-black p-2 align-top">${f.desc}</td>
                        <td class="border border-black p-2 align-top text-center ${statusClass}">${f.status}</td>
                        <td class="border border-black p-2 align-top">${observationText}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderLoggedFindingsList() {
            const listEl = document.getElementById('loggedFindingsList');
            if (!listEl) return;
            
            if (sarFindings.length === 0) {
                listEl.innerHTML = `<li class="text-gray-400 italic">No findings logged yet.</li>`;
                return;
            }

            listEl.innerHTML = sarFindings.map(f => {
                let statusColor = f.status === 'MET' ? 'text-green-600' : (f.status === 'NOT MET' ? 'text-red-600' : 'text-gray-500');
                return `<li class="${statusColor}">${f.controlId} - ${f.status}</li>`;
            }).join('');
        }


        function updateStats() {
            stats.total = sarFindings.length;
            stats.met = sarFindings.filter(f => f.status === 'MET').length;
            stats.notMet = sarFindings.filter(f => f.status === 'NOT MET').length;

            const countMetEl = document.getElementById('countMet');
            if (countMetEl) countMetEl.innerText = stats.met;
            
            const countNotMetEl = document.getElementById('countNotMet');
            if (countNotMetEl) countNotMetEl.innerText = stats.notMet;
            
            const scoreEl = document.getElementById('score');
            if (scoreEl) scoreEl.innerText = `${stats.total}`; // Total is the number of controls assessed
        }

        // --- Conclusion and Risk Logic ---

        function renderPoamBuilder() {
            const poamBuilderDiv = document.getElementById('poamBuilder');
            if (!poamBuilderDiv) return;

            const notMetControls = sarFindings.filter(f => f.status === 'NOT MET');

            if (notMetControls.length === 0) {
                poamBuilderDiv.innerHTML = `
                    <div class="bg-green-50 p-4 rounded-lg text-green-800 text-sm border-l-4 border-green-400">
                        All assessed controls are MET. No <strong>POA&amp;M</strong> development is required.
                    </div>`;
                return;
            }
            
            let html = '<p class="text-sm text-red-700 mb-4 font-semibold">The following deficiencies must be addressed to achieve certification. Complete the <strong>POA&amp;M</strong> details for each finding:</p>';
            
            notMetControls.forEach(f => {
                // Ensure poamEntries has a structure for this control before rendering inputs
                if (!poamEntries[f.controlId]) {
                    poamEntries[f.controlId] = {
                        controlId: f.controlId,
                        deficiency: f.deficiency,
                        remediation: '',
                        responsible: '',
                        milestone: ''
                    };
                }
                
                const poam = poamEntries[f.controlId];

                html += `
                    <div class="border p-4 rounded-lg bg-red-50">
                        <h4 class="font-bold text-base text-red-900 mb-2">${f.controlId} - ${controlDescriptions[f.controlId]}</h4>
                        <p class="text-xs text-red-700 mb-3"><strong>Deficiency:</strong> ${f.deficiency}</p>

                        <div class="space-y-3">
                            <div>
                                <label for="remediation-${f.controlId}" class="block text-xs font-medium text-gray-700">Remediation Action</label>
                                <textarea id="remediation-${f.controlId}" oninput="updatePoam('${f.controlId}', 'remediation', this.value)" rows="2" class="w-full border rounded p-2 text-sm" placeholder="e.g. Implement MFA on all remote access points">${poam.remediation}</textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="responsible-${f.controlId}" class="block text-xs font-medium text-gray-700">Responsible Party</label>
                                    <input type="text" id="responsible-${f.controlId}" oninput="updatePoam('${f.controlId}', 'responsible', this.value)" class="w-full border rounded p-2 text-sm" placeholder="e.g. IT Security Lead" value="${poam.responsible}">
                                </div>
                                <div>
                                    <label for="milestone-${f.controlId}" class="block text-xs font-medium text-gray-700">Completion Date (Milestone)</label>
                                    <input type="date" id="milestone-${f.controlId}" onchange="updatePoam('${f.controlId}', 'milestone', this.value)" class="w-full border rounded p-2 text-sm" value="${poam.milestone}">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            poamBuilderDiv.innerHTML = html;
        }

        function updatePoam(controlId, field, value) {
            if (poamEntries[controlId]) {
                poamEntries[controlId][field] = value;
            }
            // Trigger report render
            // NOTE: We rely on the final report render function to call all partial renders.
        }

        function renderRiskConclusion() {
            const likelihoodEl = document.getElementById('riskLikelihood');
            const impactEl = document.getElementById('riskImpact');
            const improvementRecsEl = document.getElementById('improvementRecs');
            
            const likelihood = likelihoodEl ? likelihoodEl.value : 'Low';
            const impact = impactEl ? impactEl.value : 'Low';
            const overallRisk = `${likelihood}/${impact}`;
            const improvementRecs = improvementRecsEl ? improvementRecsEl.value.replace(/\n/g, '<br>') : 'No specific recommendations provided by the assessor.';

            let poamTableHtml = '';
            const poamArray = Object.values(poamEntries);

            if (poamArray.length > 0) {
                poamTableHtml = `
                    <h5 class="font-bold text-md mb-2 mt-4 text-blue-900">5.2 Plan of Action & Milestones (POA&M)</h5>
                    <p class="text-xs text-gray-700 mb-2">The following deficiencies require documented remediation:</p>
                    <table class="w-full text-xs poam-table mb-6">
                        <thead>
                            <tr>
                                <th class="w-1/6">Control ID</th>
                                <th class="w-2/6">Deficiency</th>
                                <th class="w-2/6">Remediation Plan</th>
                                <th class="w-1/6">Milestone</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${poamArray.map(p => `
                                <tr>
                                    <td>${p.controlId}</td>
                                    <td>${p.deficiency || 'Deficiency description missing.'}</td>
                                    <td>${p.remediation || 'Remediation plan missing.'}</td>
                                    <td>${p.milestone || 'Date pending.'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (stats.total > 0 && stats.notMet === 0) {
                poamTableHtml = `
                    <h5 class="font-bold text-md mb-2 mt-4 text-blue-900">5.2 Plan of Action & Milestones (POA&M)</h5>
                    <p class="text-xs text-green-700 mb-6 font-semibold">No deficiencies (<strong>NOT MET</strong> controls) were identified; therefore, a <strong>POA&amp;M</strong> is not required.</p>
                `;
            }
            
            let conclusionFooterHtml = '';
            if (stats.total > 0) {
                let textContent = '';
                let statusColor = 'text-gray-600';

                if (stats.notMet === 0) {
                    textContent = `<span class="text-green-700 font-bold">FINAL CERTIFICATION RECOMMENDED</span><br>All assessed controls have been satisfied. The <strong>Organization Seeking Certification (OSC)</strong> is recommended for Level 2 certification.`;
                } else if (stats.notMet > 0) {
                     textContent = `<span class="text-yellow-600 font-bold">CONDITIONAL CERTIFICATION RECOMMENDED</span><br>
                     Assessment identified ${stats.notMet} deficiencies. The <strong>OSC</strong> is recommended for Conditional Certification pending the timely execution and closeout of the <strong>Plan of Action & Milestones (POA&amp;M)</strong>.`;
                } else {
                     textContent = `<span class="text-gray-600 font-bold">ASSESSMENT IN PROGRESS</span><br>
                     Final recommendation will be issued upon completion of control assessment.`;
                }
                
                conclusionFooterHtml = `
                    <div id="certificationFooter" class="mt-8">
                        <h4 class="font-bold text-lg mb-2 uppercase border-b border-gray-400">5.4 Certification Decision</h4>
                        <p class="text-sm">${textContent}</p>
                    </div>
                `;
            }

            return `
                <h4 class="font-bold text-lg mb-2 uppercase border-b border-gray-400 mt-6">5.0 Risk Management & Conclusion</h4>
                
                <h5 class="font-bold text-md mb-2 text-red-900">5.1 Risk and Impact Summary</h5>
                <table class="w-full text-xs mb-4">
                    <tr><td class="w-1/3 py-1">Likelihood:</td><td class="font-semibold">${likelihood}</td></tr>
                    <tr><td class="w-1/3 py-1">Impact:</td><td class="font-semibold">${impact}</td></tr>
                    <tr><td class="w-1/3 py-1">Overall Risk Rating:</td><td class="font-bold text-red-600">${overallRisk.toUpperCase()}</td></tr>
                </table>

                ${poamTableHtml}

                <h5 class="font-bold text-md mb-2 mt-4 text-green-900">5.3 Assessor Recommendations for Improvement</h5>
                <p class="text-xs text-gray-700 mb-4">${improvementRecs}</p>
                
                ${conclusionFooterHtml}
            `;
        }
        
        // --- Final Report Logic ---
        function renderFinalReport() {
            // 1. Get all rendered sections as HTML strings
            const execSummaryHtml = renderExecutiveSummary();
            const methodologyHtml = renderMethodology();
            const teamCredsHtml = renderTeamCredentials();
            const riskConclusionHtml = renderRiskConclusion();
            
            // 2. Generate Findings Table HTML
            const findingsTableContent = renderSarTableContent();
            const findingsHtml = `
                <h4 class="font-bold text-lg mb-2 uppercase border-b border-gray-400">4.0 Assessment Findings</h4>
                <p class="mb-4 text-gray-700 text-xs">The following table details the findings for the selected controls within the assessment scope.</p>

                <table class="w-full border-collapse border border-black sar-table text-xs">
                    <thead>
                        <tr>
                            <th class="border border-black p-2 text-left w-24">Control ID</th>
                            <th class="border border-black p-2 text-left w-48">Requirement</th>
                            <th class="border border-black p-2 text-center w-20">Status</th>
                            <th class="border border-black p-2 text-left">Assessor Observations / Risk</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${findingsTableContent}
                    </tbody>
                </table>
            `;

            // 3. Assemble the full report structure
            const fullReportHtml = `
                <!-- Header of the document page -->
                <div class="text-center mb-8 border-b-2 border-black pb-4">
                    <h2 class="text-2xl font-bold uppercase mb-1">Security Assessment Report</h2>
                    <p class="text-gray-600 italic">Prepared for: <span id="reportOrgName">${getExecutiveSummaryData().orgName}</span></p>
                    <p class="text-gray-600 text-xs mt-2">Date: <span id="reportDate">${getExecutiveSummaryData().assessmentDate}</span></p>
                </div>

                ${execSummaryHtml}
                ${methodologyHtml}
                ${teamCredsHtml}
                ${findingsHtml}
                ${riskConclusionHtml}
                
                <div class="mt-12 pt-6 border-t border-gray-400">
                    <p class="text-xs text-gray-600 text-center">--- END OF REPORT ---</p>
                    <p class="text-xs text-gray-600 text-center">Generated by CMMC Academy Study Guide</p>
                </div>
            `;
            
            const finalReportEl = document.getElementById('finalReportContent');
            if (finalReportEl) {
                finalReportEl.innerHTML = fullReportHtml;
            }
        }
        
        function printReport() {
             // Generate the final content one last time to ensure all latest inputs are captured
             renderFinalReport();
             
             // Trigger native browser print dialog, which handles PDF saving
             window.print();
        }

        function downloadCSV() {
            if (sarFindings.length === 0) {
                console.error("No findings to export.");
                alert("Cannot download: No assessment findings have been logged yet.");
                return;
            }

            const header = ["Control ID", "Requirement", "Status", "Observation", "Deficiency", "Remediation Plan", "Responsible Party", "Milestone Date"];
            let csv = header.join(",") + "\n";

            sarFindings.forEach(f => {
                const poam = poamEntries[f.controlId] || {};
                
                const row = [
                    f.controlId,
                    `"${f.desc.replace(/"/g, '""')}"`,
                    f.status,
                    `"${f.observation.replace(/"/g, '""').replace(/\n/g, ' ')}"`, // Observation
                    `"${f.deficiency.replace(/"/g, '""').replace(/\n/g, ' ')}"`,  // Deficiency
                    `"${poam.remediation ? poam.remediation.replace(/"/g, '""').replace(/\n/g, ' ') : ''}"`, // POA&M
                    `"${poam.responsible ? poam.responsible.replace(/"/g, '""') : ''}"`,
                    poam.milestone || ''
                ];
                csv += row.join(",") + "\n";
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `CMMC_SAR_Findings_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        function clearReport() {
            sarFindings = [];
            poamEntries = {};
            
            // Reset stats display
            updateStats();
            renderLoggedFindingsList();
            
            // Clear inputs in Risk/Conclusion tab
            const likelihoodEl = document.getElementById('riskLikelihood');
            if (likelihoodEl) likelihoodEl.value = 'Low';
            const impactEl = document.getElementById('riskImpact');
            if (impactEl) impactEl.value = 'Low';
            const improvementRecsEl = document.getElementById('improvementRecs');
            if (improvementRecsEl) improvementRecsEl.value = '';

            // Re-render all sections to reflect the empty state
            renderFinalReport();
            
            // Refresh the builder tabs
            renderPoamBuilder(); 
        }

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            // 1. Set default assessment date to today
            const today = new Date().toISOString().split('T')[0];
            const assessmentDateElement = document.getElementById('assessmentDate');
            if (assessmentDateElement) {
                assessmentDateElement.value = today;
            }

            // 2. Initial state setup
            updateControlDesc();
            renderAssetLists(); 
            renderTeamCredentials();
            updateStats();
            
            // 3. Render the initial tab content
            const execContent = renderExecutiveSummary();
            const execDiv = document.getElementById('executiveSummaryContent');
            if (execDiv) execDiv.innerHTML = execContent;

            // 4. Set the default visible SAR Deep Dive part
            showSarPart('executive'); 

            // 5. Initial render of the final report preview
            renderFinalReport();
        });
    </script>
</body>
</html>
